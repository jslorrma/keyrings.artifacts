name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  lint:
    name: >-
      Lint the codebase ğŸ§¹ with ruff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the codebase ğŸ“¥
        uses: actions/checkout@v3

      - name: Set up the pixi environment ğŸŒŸ
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          environments: dev

      - name: Run code linting with ruff check ğŸ”
        run: pixi run -e dev ruff-check

      - name: Format the code with ruff format ğŸ¨
        run: pixi run -e dev format

  test:
    name: >-
      Run tests ğŸ§ª and upload coverage report ğŸ“Š
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the codebase ğŸ“¥
        uses: actions/checkout@v3

      - name: Set up the pixi environment ğŸŒŸ
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          environments: dev

      - name: Execute tests ğŸ§ª
        run: pixi run -e dev test-reports

      - name: Upload the coverage report ğŸ“Š
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: reports/

  version-check:
    name: >-
      Check if the version has changed ğŸ”„
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-metadata.outputs.changed }}
      new-version: ${{ steps.version-metadata.outputs.newVersion }}
    steps:
      - name: Checkout the codebase ğŸ“¥
        uses: actions/checkout@v3

      - name: Retrieve the current version ğŸ•µï¸â€â™‚ï¸
        id: get-version
        run: |
          echo "current_version=$(grep -Po '(?<=^__version__ = ")[^"]*' src/keyrings_artifacts/_version.py)" >> $GITHUB_ENV

      - name: Fetch the previous version from tags ğŸ·ï¸
        id: get-previous-version
        run: |
          git fetch --tags
          echo "previous_version=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Compare the current and previous versions ğŸ”„
        id: version-metadata
        run: |
          if [ "$current_version" != "$previous_version" ]; then
              echo "::set-output name=changed::true"
              echo "::set-output name=newVersion::$current_version"
          else
              echo "::set-output name=changed::false"
          fi

  build:
    name: >-
      Build the Python ğŸ package ğŸ“¦
    runs-on: ubuntu-latest
    needs: version-check
    if: needs.version-check.outputs.version-changed == 'true'
    steps:
      - name: Checkout the codebase ğŸ“¥
        uses: actions/checkout@v3

      - name: Set up the pixi environment ğŸŒŸ
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          environments: ci

      - name: Build the package ğŸ“¦
        run: pixi run -e dev build

      - name: Store the distribution packages ğŸ“¦
        uses: actions/upload-artifact@v3
        with:
          name: python-package-distributions
          path: dist/

  publish-to-testpypi:
    name: >-
      Publish the Python ğŸ distribution ğŸ“¦ to TestPyPI
    needs:
      - version-check
      - build
    runs-on: ubuntu-latest
    if: needs.version-check.outputs.version-changed == 'true'

    environment:
      name: testpypi
      url: https://test.pypi.org/p/keyrings.artifacts

    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
      - name: Download all the distribution packages ğŸ“¦
        uses: actions/download-artifact@v3
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish the distribution ğŸ“¦ to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
